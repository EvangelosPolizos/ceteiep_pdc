# Παραδείγματα εργαστηρίου (2019-2020)

## Ημερολόγιο μαθημάτων

* 21/02/2020 (Παρασκευή 13:00-15:00) {Τμήμα 1 + Τμήμα 2}
* 26/02/2020 (Τετάρτη 12:00-14:00)   {Τμήμα 1}
* 06/03/2020 (Παρασκευή 13:00-15:00) {Τμήμα 2}
* 13/03/2020 (Παρασκευή 13:00-15:00) {Τμήμα 1}

---

* 27/3/2020 (Παρασκευή 13:00-15:00) {MSTEAMS}

### ΕΡΓΑΣΤΗΡΙΟ 1 & 2

Σειριακός κώδικας που υπολογίζει το άθροισμα ακεραίων από το 1 μέχρι και το Ν (Ν=10000).

* [lc00_serial.c](./lc00_serial.c)

    ```bash
    $ gcc lc00_serial.c -o lc00_serial
    $ ./lc00_serial
    ```

Παράδειγμα με POSIX Processes. Υπολογισμός αθροίσματος ακεραίων τιμών από το 1 μέχρι και το Ν (Ν=10000) χρησιμοποιώντας 2 διεργασίες. Η διεργασία παιδί υπολογίζει το άθροισμα 1 + 2 + ... + Ν/2 ενώ η διεργασία γονέας υπολογίζει το άθροισμα (Ν/2 + 1) + (Ν/2 + 2) + ... + Ν.

* [lc01_processes.c](./lc01_processes.c)

    ```bash
    $ gcc lc01_processes.c -o lc01_processes
    $ ./lc01_processes
    ```

Παράδειγμα με pThreads. Υπολογισμός αθροίσματος ακεραίων τιμών από το 1 μέχρι και το Ν (Ν=10000) χρησιμοποιώντας Τ νήματα (Τ=2). Το ένα νήμα υπολογίζει το άθροισμα 1 + 2 + ... + Ν/2 ενώ το άλλο νήμα υπολογίζει το άθροισμα Ν/2+1 + Ν/2+2 + ... + Ν. Το κύριο νήμα αναλαμβάνει την πρόσθεση των αθροισμάτων που υπολογίζουν τα νήματα.

* [lc02_pthreads.c](./lc02_pthreads.c) Απλοϊκή έκδοση, ξεχωριστή συνάρτηση για κάθε νήμα.

    ```bash
    $ gcc lc02_pthreads.c -o lc02_pthreads -lpthread
    $ ./lc02_pthreads
    ```

* [lc02_pthreads1.c](./lc02_pthreads1.c) Έκδοση που λειτουργεί και με περισσότερα από 2 threads.

    ```bash
    $ gcc lc02_pthreads1.c -o lc02_pthreads1 -lpthread
    $ ./lc02_pthreads1
    ```

* [lc02_pthreads2.c](./lc02_pthreads2.c) Έκδοση που λειτουργεί και με περισσότερα από 2 threads (αλλαγή στον τρόπο με τον οποίο περνά το αναγνωριστικό νήματος στη συνάρτηση που θα εκτελέσει το νήμα).

    ```bash
    $ gcc lc02_pthreads2.c -o lc02_pthreads2 -lpthread
    $ ./lc02_pthreads2
    ```

* [lc02_pthreads3.c](./lc02_pthreads3.c) Έκδοση του κώδικα που δέχεται τον αριθμό νημάτων ως παράμετρο γραμμής εντολών.

    ```bash
    $ gcc lc02_pthreads3.c -o lc02_pthreads3 -lpthread
    $ ./lc02_pthreads3 10
    ```

* [lc02_pthreads4.c](./lc02_pthreads4.c) Έκδοση του κώδικα που δέχεται τον αριθμό νημάτων ως παράμετρο γραμμής εντολών και χρησιμοποιεί mutex για συγχρονισμό των νημάτων.

    ```bash
    $ gcc lc02_pthreads4.c -o lc02_pthreads4 -lpthread
    $ ./lc02_pthreads4 10
    ```

### ΕΡΓΑΣΤΗΡΙΟ 3

Κώδικας υπολογισμού y = A * x (δίνεται ο δισδιάστατος πίνακας Α και το διάνυσμα x)

* [lc03_pthreads5.c](./lc03_pthreads5.c)
  
Κώδικες που επιδεικνύουν την αναγκαιότητα συγχρονισμού στον παράλληλο και ταυτόχρονο προγραμματισμό.

Ένα σύνολο νημάτων πραγματοποιούν τον ίδιο αριθμό μοναδιαίων αυξήσεων και μοναδιαίων μειώσεων στην κοινόχρηστη μεταβλητή counter που αρχικοποιείται στην τιμή 0. Η τελική τιμή της μεταβλητής counter θα έπρεπε να είναι 0 αλλά λόγω "συνθήκης ανταγωνισμού" δεν λαμβάνεται το σωστό αποτέλεσμα.

* [lc03_pthreads6.c](./lc03_pthreads6.c)

Επίλυση του προβλήματος με busy_wait (για 4 νήματα).

* [lc03_pthreads6_busy_wait.c](./lc03_pthreads6_busy_wait.c)

Το busy wait είναι επικίνδυνο αν πρόκειται να ζητηθεί βελτιστοποίηση κατά τη μεταγλώττιση. Επίλυση του προβλήματος με χρήση volatile μεταβλητών.

* [lc03_pthreads6_busy_wait_volatile.c](./lc03_pthreads6_busy_wait_volatile.c)

Επίλυση του προβλήματος με αμοιβαίο αποκλεισμό (mutex).

* [lc03_pthreads6_mutex.c](./lc03_pthreads6_mutex.c)

Επίλυση του προβλήματος με σημαφόρους.

* [lc03_pthreads6_semaphore.c](./lc03_pthreads6_semaphore.c)

### ΕΡΓΑΣΤΗΡΙΟ 4



### ΕΡΓΑΣΤΗΡΙΟ 5

Πολλές υλοποιήσεις pthreads δεν έχουν υλοποίηση των φραγμάτων. Προκειμένου να είναι ο κώδικας μεταφέρσιμος μπορεί να κατασκευαστεί κάποια custom υλοποίηση.

[lc04_simple_custom_barrier.c](./lc04_simple_custom_barrier.c)

Χρησιμότητες των barriers

* Αναγκαιότητα εφαρμογής (υπολογισμοί Φάσης Α που πρέπει να ολοκληρωθεί από κάποια threads πριν τα νήματα προχωρήσουν σε μια δεύτερη φάση υπολογισμών)
* Χρονομέτρηση κώδικα
* Διευκόλυνση αποσφαλμάτωσης

Παράδειγμα προβλήματος με απαίτηση barrier: Έστω ότι 10 νήματα πρέπει πρώτα να προσθέσουν από μια μονάδα σε μια κοινόχρηστη μεταβλητή και μετά το καθένα να διπλασιάσει τη μεταβλητή.

* Κώδικας χωρίς barrier (λάθος αποτελέσματα)
  * [lc04_custom_barrier1.c](./lc04_custom_barrier1.c)
* Custom υλοποίηση φράγματος με mutex και αναμονή σε εκρήγορση
  * [lc04_custom_barrier2.c](./lc04_custom_barrier2.c)
* Custom υλοποίηση φράγματος με conditional variable
  * [lc04_custom_barrier3.c](./lc04_custom_barrier3.c)
* Σε Linux (π.χ. Ubuntu) υπάρχει υλοποίηση των barriers στο gcc
  * [lc04_barrier.c](./lc04_barrier.c)
